!function(e){var n={};function s(t){if(n[t])return n[t].exports;var r=n[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=e,s.c=n,s.d=function(e,n,t){s.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:t})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,n){if(1&n&&(e=s(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(s.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var r in e)s.d(t,r,function(n){return e[n]}.bind(null,r));return t},s.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(n,"a",n),n},s.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},s.p="",s(s.s=5)}([function(e,n){e.exports=require("mongodb")},function(e,n){e.exports=require("bcryptjs")},function(e,n){e.exports=require("validator")},function(e,n,s){"use strict";n.__esModule=!0,n.default=function(e,n,s){return e.session.user?s():n.status(401).json({error:"Not authorized"})}},function(e,n){e.exports=require("path")},function(e,n,s){"use strict";(function(e){n.__esModule=!0;var t=s(6),r=s(7),o=s(8),i=s(4),u=s(0),a=s(9),c=s(1),l=s(10),d=s(11),f=s(12)(o),m=s(13),p=s(14),g=s(22),v=s(24),y=r(),h=process.env.PORT||3e3,b=l();y.engine("html",m()),y.set("view engine","html"),u.MongoClient.connect(v.mongodbConnectionUri,{useNewUrlParser:!0},function(n,s){if(n)return console.error(n);var u=s.db();y.use(function(e,n,s){return e.db=u,s()});var l=o({secret:"some secret",saveUninitialized:!0,resave:!1,cookie:{secure:!1},store:new f({db:u,collection:"session"})});y.use(a.json()),y.use(a.urlencoded({extended:!0})),y.use(l),y.use(b),y.use(d()),y.use(function(e,n,s){e.authenticate=function(n,s,t){u.collection("users").findOne({email:n}).then(function(n){if(null===n||!c.compareSync(s,n.password))return t(!1);var r={email:n.email,name:n.name,role:n.role};return e.session.user=r,t(r)})},e.logout=function(){e.session.user=null},s()}),p.default(y),y.get("/",function(n,s){s.render(i.resolve(e,"../../dist/public/index.html"),{csrfToken:n.csrfToken()})}),y.use(r.static(i.resolve(e,"../../dist/public/"))),y.get("*",function(n,s){s.render(i.resolve(e,"../../dist/public/index.html"),{csrfToken:n.csrfToken()})});var m=t.createServer(y);g.default(m,u,l),m.listen(h,function(){console.log("Listening on port "+h+"!")})}),n.default=y}).call(this,"src/server")},function(e,n){e.exports=require("http")},function(e,n){e.exports=require("express")},function(e,n){e.exports=require("express-session")},function(e,n){e.exports=require("body-parser")},function(e,n){e.exports=require("csurf")},function(e,n){e.exports=require("helmet")},function(e,n){e.exports=require("connect-mongo")},function(e,n){e.exports=require("mustache-express")},function(e,n,s){"use strict";n.__esModule=!0;var t=s(15),r=s(21);n.default=function(e){r.default(e),t.default(e)}},function(e,n,s){"use strict";n.__esModule=!0;var t=s(1),r=s(2),o=s(16),i=s(17),u=s(18),a=s(20);n.default=function(e){e.use(function(e,n,s){return n.set("new-csrf-token",e.csrfToken()),s()}),o.default(e),i.default(e),u.default(e),e.post("/api/v1/login",function(e,n){return r.isEmpty(e.body.email)||r.isEmpty(e.body.password)?n.status(400).json({error:"Please supply an email and password"}):r.isEmail(e.body.email)?void e.authenticate(e.body.email,e.body.password,function(s){return s?n.json({success:!0,email:e.session.user.email,role:e.session.user.role,name:e.session.user.name}):n.status(401).json({error:"Invalid email or password"})}):n.status(400).json({error:"Not a valid email address"})}),e.post("/api/v1/register",function(e,n){if(r.isEmpty(e.body.email)||r.isEmpty(e.body.password))return n.status(400).json({error:"Please supply an email and password"});if(!r.isEmail(e.body.email))return n.status(400).json({error:"Not a valid email address"});var s=t.hashSync(e.body.password),o=e.db.collection("users");o.findOne({email:e.body.email}).then(function(t){if(null!==t)return n.status(401).json({error:"Email address already in use"});o.countDocuments().then(function(t){var r="user";0===t&&(r="admin",e.db.collection("widgets").insertOne({shortId:a.generate(),domain:"http://localhost:4000"})),o.insertOne({email:e.body.email,password:s,emailVerified:!1,role:r},function(e){return n.json({success:!0})})})})}),e.post("/api/v1/verifyEmail",function(e,n){if(r.isEmpty(e.body.key))return n.status(400).json({error:"Invalid request, no key supplied"});e.db.collection("users").findOneAndUpdate({verifyKey:e.body.key},{$set:{emailVerified:!0,verifyKey:null}},function(e,s){return e||!s?(console.log(e,s),n.status(400).json({error:"Invalid key"})):n.status(200).json({success:!0})})}),e.get("/api/v1/logout",function(e,n){return e.logout(),n.json({success:!0,message:"logged out"})})}},function(e,n,s){"use strict";n.__esModule=!0;var t=s(1),r=s(2),o=s(3);n.default=function(e){e.get("/api/v1/user*",o.default),e.get("/api/v1/user",function(e,n){n.send(e.session.user)}),e.get("/api/v1/users",function(e,n){var s=e.db.collection("users"),t=[];s.find({}).forEach(function(e){t.push({name:e.name||"",email:e.email,role:e.role})},function(e){return e?(console.log(e),n.status(500).json({error:"Something went wrong retrieving users"})):n.status(200).json({success:!0,users:t})})}),e.get("/api/v1/user/:user",function(e,n){e.db.collection("users").findOne({email:e.params.user},function(e,s){return e?n.status(400).json({error:e}):n.json({user:{email:s.email,_id:s._id,name:""}})})}),e.post("/api/v1/user/update/email",function(e,n){if(!r.isEmail(e.body.email))return n.status(400).json({error:"Not a valid email"});var s=e.db.collection("users");return s.countDocuments({email:e.body.email},function(t,r){return t?(console.log(t),n.status(500).json({error:"Something went wrong counting users with email "+e.body.email})):0!==r?n.status(400).json({error:"Email address already in use"}):void s.updateOne({email:e.session.user.email},{$set:{email:e.body.email}},function(s,t){return s||!t?(console.log(s,t),n.status(500).json({error:"Something went wrong trying to update user's email"})):(e.session.user.email=e.body.email,n.status(200).json({success:!0}))})})}),e.post("/api/v1/user/update/name",function(e,n){e.db.collection("users").updateOne({email:e.session.user.email},{$set:{name:e.body.name}},function(s,t){return s||!t?(console.log(s,t),n.status(500).json({error:"Something went wrong trying to update user's name"})):(e.session.user.name=e.body.name,n.status(200).json({success:!0}))})}),e.post("/api/v1/user/update/password",function(e,n){var s=e.db.collection("users");return r.isEmpty(e.body.newPass)||r.isEmpty(e.body.oldPass)?n.status(400).json({error:"Must supply the current and new password"}):s.findOne({email:e.session.user.email},function(r,o){return r||!o?(console.log(r),n.status(500).json({error:"Something went wrong trying to retrieve the logged in user"})):t.compareSync(e.body.oldPass,o.password)?void s.updateOne({email:e.session.user.email},{$set:{password:t.hashSync(e.body.newPass)}},function(e,s){return e?(console.log(e),n.status(500).json({error:"Something went wrong trying to update the logged in user's password"})):n.status(200).json({success:!0})}):n.status(400).json({error:"Invalid password"})})}),e.post("/api/v1/user/reset_password",function(e,n){}),e.post("/api/v1/user/resend_email_verification")}},function(e,n,s){"use strict";n.__esModule=!0;var t=s(3),r=s(0);n.default=function(e){e.get("/api/v1/messages?",t.default),e.get("/api/v1/messages/:channel/:offset",function(e,n){e.db.collection("messages").find({channel:e.params.channel},{skip:parseInt(e.params.offset),sort:[["_id",-1]],limit:20}).toArray(function(e,s){if(!s)return n.status(400).json({json:e});s.toArray(function(e,s){return n.json({messages:s.map(function(e){var n=new r.ObjectID(e._id);return e.created=n.getTimestamp(),e}).reverse()})})})})}},function(e,n,s){"use strict";n.__esModule=!0;var t=s(3),r=s(19),o=s(2);n.default=function(e){e.get("/api/v1/channel*",t.default),e.get("/api/v1/channels",function(e,n){e.db.collection("channels",function(e,s){new Promise(function(e){s.find({}).count(function(n,t){0===t?s.insertMany([{name:"general"},{name:"random"}],function(){return e()}):e()})}).then(function(){s.find({}).toArray(function(e,s){n.json({channels:s})})})})}),e.get("/api/v1/channel/delete/:channel",r.default,function(e,n){return o.isEmpty(e.params.channel)?n.status(400).json({error:"Invalid channel name"}):e.db.collection("channels",function(s,t){var r=new Promise(function(n,s){t.find({name:e.params.channel}).count(function(e,t){return 1===t?n():s()})});return r.then(function(){t.deleteOne({name:e.params.channel}).then(function(){return n.json({success:!0})})}).catch(function(){return n.status(400).json({error:"Returned channels count not equal to 1"})}),r})}),e.post("/api/v1/channel/create",r.default,function(e,n){return o.isEmpty(e.body.channelName)?n.status(400).json({error:"Invalid channel name"}):e.db.collection("channels",function(s,t){return new Promise(function(n,s){t.countDocuments({name:e.body.channelName},function(e,t){return 0!==t?s():n()})}).then(function(){return t.insertOne({name:e.body.channelName}).then(function(){return n.json({success:!0})})}).catch(function(){return n.status(400).json({error:"Channel already exists"})})})})}},function(e,n,s){"use strict";n.__esModule=!0,n.default=function(e,n,s){return e.session.user&&"admin"===e.session.user.role?s():n.status(401).json({error:"Not authorized as admin"})}},function(e,n){e.exports=require("shortid")},function(e,n,s){"use strict";(function(e){n.__esModule=!0;var t=s(4);n.default=function(n){n.get("/widget",function(n,s){s.render(t.resolve(e,"../../../dist/public/widget/index.html"))}),n.get("/widget/demo",function(n,s){s.render(t.resolve(e,"../../../dist/public/widget/demo.html"))})}}).call(this,"src/server/routes")},function(e,n,s){"use strict";n.__esModule=!0;var t=s(23),r=s(0);n.default=function(e,n,s){var o=t(e),i=[];o.use(function(e,n){s(e.request,e.request.res,n)}),o.use(function(e,n){if(e.request.session.user.email)return n();n(new Error("Authentication error"))}),o.on("connection",function(e){i.push(e.request.session.user.email),console.log("Connected users",i),o.emit("connected users",i.filter(function(e,n,s){return s.indexOf(e)===n})),e.on("disconnect",function(){i.splice(i.indexOf(e.request.session.user.email),1),o.emit("connected users",i.filter(function(e,n,s){return s.indexOf(e)===n}))}),e.on("message",function(s){console.log(s),n.collection("messages").insertOne({channel:s.channel,text:s.text,userEmail:e.request.session.user.email},function(n,t){return n?console.error(n):(o.emit("message",{_id:t.insertedId,userEmail:e.request.session.user.email,text:s.text,channel:s.channel,created:new r.ObjectID(t.insertedId).getTimestamp()}),e.emit("message received"))})})})}},function(e,n){e.exports=require("socket.io")},function(e,n){e.exports={mongodbConnectionUri:process.env.MONGODB_URI,mailgunApiKey:process.env.MAILGUN_API_KEY,mailgunDomain:process.env.MAILGUN_DOMAIN,baseUrl:process.env.BASE_URL?process.env.BASE_URL:"http://localhost:5000"}}]);
//# sourceMappingURL=server.js.map