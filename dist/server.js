!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=8)}([function(e,t){e.exports=require("mongoose")},function(e,t,n){e.exports={mongodbConnectionUri:process.env.MONGODB_URI,mongodbTestConnectionUri:process.env.MONGODB_TEST_URI||"mongodb://localhost:27017/openChatTest",port:process.env.PORT||5e3,production:!0,useTestDb:process.env.USE_TEST_DB||!1,secret:process.env.SECRET||"secret",disableCsrf:process.env.DISABLE_CSRF||!1,disableReduxLogging:process.env.DISABLE_REDUX_LOGGING||!1,disableAutoStart:process.env.DISABLE_AUTO_START||!1,mailgunApiKey:process.env.MAILGUN_API_KEY,mailgunDomain:process.env.MAILGUN_DOMAIN,baseUrl:process.env.BASE_URL?process.env.BASE_URL:"http://localhost:5000"}},function(e,t){e.exports=require("bcryptjs")},function(e,t,n){"use strict";t.__esModule=!0;var r=n(0),o=new r.Schema({name:String,email:{required:!0,type:String,lowercase:!0},password:{type:String,required:!0},role:{type:String,required:!0,lowercase:!0,enum:["admin","user"]}},{timestamps:!0});o.statics.findByEmail=function(e){return this.findOne({email:e})};var s=r.model("User",o);t.default=s},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("validator")},function(e,t,n){"use strict";t.__esModule=!0;var r=n(0),o=new r.Schema({channel:{type:String,required:!0},text:{type:String,required:!0},userEmail:{type:String,required:!0,lowercase:!0}},{timestamps:!0}),s=r.model("Message",o);t.default=s},function(e,t,n){"use strict";(function(e){t.__esModule=!0;var r=n(9),o=n(10),s=n(4),u=n(0),i=n(11),a=n(12),c=n(13),l=n(14),d=n(2),f=n(15),m=n(16),p=n(5),g=n(17),h=n(18)(c),y=n(19),v=n(27),w=n(3),b=n(1),j=o();t.app=j;var x,S,E=b.port;t.socketServer=S,j.engine("html",g()),j.set("view engine","html"),j.use(m());var _=c({secret:b.secret,cookie:{maxAge:864e5,sameSite:!0,secure:b.production,httpOnly:!0},saveUninitialized:!0,resave:!1,store:new h({mongooseConnection:u.connection})}),M=i({cookie:{maxAge:864e5,sameSite:!0,secure:b.production,httpOnly:!0,key:"_csrf"}});u.connect(b.useTestDb?b.mongodbTestConnectionUri:b.mongodbConnectionUri,{useNewUrlParser:!0}),u.connection.on("error",function(e){console.error("Mongoose connection error",e)}),process.on("SIGINT",function(){u.connection.close(function(){console.log("Mongoose default connection disconnected through app termination"),process.exit(0)})}),j.use(_),j.use(a(b.secret)),b.disableCsrf?(console.log("CSRF disabled"),j.use(function(e,t,n){return e.csrfToken=function(){return""},n()})):j.use(M);var T=u.connection;j.use(function(e,t,n){return e.db=T,n()}),j.use(l.json()),j.use(l.urlencoded({extended:!0})),j.use(f()),j.use(o.static(s.resolve(e,"../../dist/public/"))),j.use("/api",function(e,t,n){return n()}),j.use(function(e,t,n){e.authenticate=function(e,t,n){w.default.findByEmail(e).then(function(e){if(null===e)return n(!1,null);if(!d.compareSync(t,e.password))return n(!1,new Error("Invalid password"));var r={email:e.email,name:e.name,role:e.role};return n(r,null)}).catch(function(e){n(!1,e)})},e.logout=function(){e.session.token=null},e.issueNewToken=function(n){var r=p.sign({name:n.name,role:n.role,email:n.email},b.secret,{expiresIn:86400});t.setHeader("x-access-token",r),e.session.token=r},n()}),y.default(j),(x=r.createServer(j)).on("error",function(e){console.error(e),x.close()}),b.disableAutoStart||(t.socketServer=S=v.default(x,T),u.connection.on("connected",function(){console.log("Connected to MongoDB via Mongoose"),x.listen(E,function(){console.log("Listening on port "+E+"!"),j.emit("server started")})})),t.default=x,t.conn=u.connection}).call(this,"src/server")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("csurf")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("helmet")},function(e,t){e.exports=require("compression")},function(e,t){e.exports=require("mustache-express")},function(e,t){e.exports=require("connect-mongo")},function(e,t,n){"use strict";(function(e){t.__esModule=!0;var r=n(4),o=n(20),s=n(21),u=n(22),i=n(23),a=n(24),c=n(25);t.default=function(t){t.get("/",function(t,n){return n.render(r.resolve(e,"../../dist/public/index.html"),{csrfToken:t.csrfToken()})}),t.get("/widget",function(t,n){return n.render(r.resolve(e,"../../../dist/public/widget/index.html"))}),t.get("/widget/demo",function(t,n){return n.render(r.resolve(e,"../../../dist/public/widget/demo.html"))}),t.post("/api/v1/login",u.default.login),t.post("/api/v1/register",u.default.register),t.get("/api/v1/logout",u.default.logout),t.get("/api/v1/verifyEmail/:id",u.default.verifyEmail),t.use("/api/v1/user*",o.default),t.get("/api/v1/user",i.default.user),t.get("/api/v1/users",i.default.users),t.get("/api/v1/user/:user",i.default.userByEmail),t.post("/api/v1/user/update/email",i.default.updateEmail),t.post("/api/v1/user/update/name",i.default.updateName),t.post("/api/v1/user/update/password",i.default.updatePassword),t.post("/api/v1/user/reset_password",i.default.resetPassword),t.post("/api/v1/user/create",s.default,i.default.createUser),t.put("/api/v1/user/update",s.default,i.default.editUser),t.post("/api/v1/user/delete",s.default,i.default.deleteUser),t.use("/api/v1/message*",o.default),t.get("/api/v1/messages/:channel/:offset",a.default.messages),t.use("/api/v1/channel",o.default),t.get("/api/v1/channels",c.default.channels),t.post("/api/v1/channels/delete",s.default,c.default.delete),t.post("/api/v1/channels/create",s.default,c.default.create),t.get("*",function(t,n){return n.render(r.resolve(e,"../../dist/public/index.html"),{csrfToken:t.csrfToken()})})}}).call(this,"src/server")},function(e,t,n){"use strict";t.__esModule=!0;var r=n(5),o=n(1);t.default=function(e,t,n){var s=e.session.token||e.headers["x-access-token"];if(!s)return t.status(401).json({error:"Not authorized"});r.verify(s,o.secret,function(r,o){return r?t.status(401).send({error:"Not authorized"}):(e.user=o,n())})}},function(e,t,n){"use strict";t.__esModule=!0,t.default=function(e,t,n){return e.user&&"admin"===e.user.role?n():t.status(401).json({error:"Not authorized as admin"})}},function(e,t,n){"use strict";t.__esModule=!0;var r=n(6),o=n(2),s=n(3);n(1);t.default={login:function(e,t){return r.isEmpty(e.body.email||"")||r.isEmpty(e.body.password||"")?t.status(400).json({error:"Please supply an email and password"}).end():r.isEmail(e.body.email)?void e.authenticate(e.body.email,e.body.password,function(n){return n?(e.issueNewToken(n),t.status(200).json({success:!0,email:n.email,role:n.role,name:n.name}).end()):t.status(401).json({error:"Invalid email or password"}).end()}):t.status(400).json({error:"Not a valid email address"}).end()},register:function(e,t){return r.isEmpty(e.body.email||"")||r.isEmpty(e.body.password||"")?t.status(400).json({error:"Please supply an email and password"}):r.isEmail(e.body.email)?s.default.findByEmail(e.body.email).countDocuments().exec().then(function(n){if(0!==n)return t.status(400).json({error:"Email address in use"});var r=o.hashSync(e.body.password);s.default.countDocuments().exec().then(function(n){var o="user";0===n&&(o="admin"),new s.default({name:"",email:e.body.email,password:r,role:o,emailVerified:!1}).save().then(function(e){return t.status(200).json({success:!0})}).catch(function(e){return console.error(e),t.status(500).json({error:"Something went wrong trying to create a new user"})})})}):t.status(400).json({error:"Not a valid email address"})},logout:function(e,t){return e.logout(),t.json({success:!0,message:"logged out"})},verifyEmail:function(e,t){}}},function(e,t,n){"use strict";t.__esModule=!0;var r=n(6),o=n(3),s=n(2);t.default={user:function(e,t){t.send(e.user)},users:function(e,t){return o.default.find({}).select("name email role").then(function(e){return t.status(200).json({success:!0,users:e})}).catch(function(e){return console.error(e),t.status(500).json({error:"Something went wrong while retrieving users"})})},userByEmail:function(e,t){return r.isEmail(e.params.user)?o.default.findByEmail(e.params.user).exec().then(function(e){return null!==e?t.status(200).json({user:{email:e.email,_id:e._id,name:e.name||"",role:e.role,created:e.createdAt}}):t.status(400).json({error:"No user found with that email"})}).catch(function(e){return console.error(e),t.status(500).json({error:"Something went wrong trying to find the user"})}):t.status(400).json({error:"Please supply a valid email"})},updateEmail:function(e,t){return r.isEmail(e.body.email)?o.default.countDocuments({email:e.body.email}).exec().then(function(n){return 0!==n?t.status(400).json({error:"Email address already in use"}):o.default.findByEmail(e.user.email).exec().then(function(n){return n.email=e.body.email,n.save(),e.issueNewToken(Object.assign({},e.user,{email:e.body.email})),t.status(200).json({success:!0})}).catch(function(e){return console.error(e),t.status(500).json({error:"Something went wrong trying to fetch the user"})})}):t.status(400).json({error:"Not a valid email"})},updateName:function(e,t){return o.default.findByEmail(e.user.email).exec().then(function(n){return n.name=e.body.name,n.save(),e.issueNewToken(Object.assign({},e.user,{name:e.body.name})),t.status(200).json({success:!0})}).catch(function(e){return console.error(e),t.status(500).json({error:"Something went wrong trying to update the user"})})},updatePassword:function(e,t){return r.isEmpty(e.body.newPass)||r.isEmpty(e.body.oldPass)?t.status(400).json({error:"Must supply the current and new password"}):o.default.findByEmail(e.user.email).exec().then(function(n){return s.compareSync(e.body.oldPass,n.password)?(n.password=s.hashSync(e.body.newPass),n.save(),t.status(200).json({success:!0})):t.status(400).json({error:"Current password is incorrect"})})},resetPassword:function(e,t){return t.status(500).json({error:"Not implemented"})},createUser:function(e,t){return r.isEmpty(e.body.email)||!r.isEmail(e.body.email)||r.isEmpty(e.body.role)||"user"!==e.body.role&&"admin"!==e.body.role?t.status(400).json({error:"Must supply valid email and role"}):o.default.findByEmail(e.body.email).countDocuments(function(n,r){return n?(console.error("Something went wrong trying to count users with email "+e.body.email,n),t.status(500).json({error:"Something went wrong"})):0!==r?t.status(400).json({error:"Email address in use"}):new o.default({email:e.body.email,name:e.body.name||"",role:e.body.role,password:"temp"}).save(function(e,n){return e?(console.error("Something went wrong trying to save user",e),t.status(500).json({error:"Something went wrong"})):t.status(200).json({success:!0})})})},editUser:function(e,t){return e.body.email&&r.isEmail(e.body.email)?e.body.user.email&&!r.isEmail(e.body.user.email)?t.status(400).json({error:"Please supply a valid email"}):e.body.user.role&&!r.isEmpty(e.body.user.role)&&"user"!==e.body.user.role&&"admin"!==e.body.user.role?t.status(400).json({error:"Invalid role"}):o.default.findByEmail(e.body.email).exec(function(n,r){return n?(console.log("Something went wrong",n),t.status(500).json({error:"Something went wrong"})):r?(e.body.user.email&&(r.email=e.body.user.email),e.body.user.name&&(r.name=e.body.user.name),e.body.user.role&&(r.role=e.body.user.role),r.save(function(e,n){return e?(console.log(e),t.status(500).json({error:"Something went wrong"})):t.status(200).json({success:!0})})):t.status(404).json({error:"User does not exist"})}):t.status(400).json({error:"Please supply a valid email"})},deleteUser:function(e,t){}}},function(e,t,n){"use strict";t.__esModule=!0;var r=n(7);t.default={messages:function(e,t){return r.default.find({channel:e.params.channel}).skip(parseInt(e.params.offest)).sort({_id:-1}).limit(20).exec().then(function(e){return t.status(200).json({messages:e.map(function(e){return{text:e.text,created:e.createdAt,userEmail:e.userEmail,channel:e.channel,_id:e._id}}).reverse()})}).catch(function(e){return t.status(400).json({error:"something went wrong trying to fetch messages"})})}}},function(e,t,n){"use strict";t.__esModule=!0;var r=n(26);t.default={channels:function(e,t){return r.default.countDocuments().exec().then(function(e){return new Promise(function(t,n){if(0!==e)return t();r.default.create([{name:"general"},{name:"random"}]).then(function(){return t()}).catch(function(e){return n(e)})}).then(function(){r.default.find().exec().then(function(e){return t.status(200).json({channels:e})}).catch(function(e){return console.log(e),t.status(500).json({error:"Something went wrong while trying to fetch channels"})})}).catch(function(e){return console.error(e),t.status(500).json({error:"Something went wrong while trying to create default channels"})})}).catch(function(e){return console.error(e),t.status(500).json({error:"Something went wrong while counting channels"})})},delete:function(e,t){},create:function(e,t){}}},function(e,t,n){"use strict";t.__esModule=!0;var r=n(0),o=new r.Schema({name:{type:String,required:!0,lowercase:!0}},{timestamps:!0}),s=r.model("Channel",o);t.default=s},function(e,t,n){"use strict";t.__esModule=!0;var r=n(28),o=n(29),s=n(7),u=n(1);t.default=function(e,t){var n=r(e),i=[];return n.on("connection",o.authorize({secret:u.secret,timeout:15e3,decodedPropertyName:"jwt"})).on("authenticated",function(e){i.push(e.jwt.email),console.log("Connected users",i),n.emit("connected users",i.filter(function(e,t,n){return n.indexOf(e)===t})),e.on("disconnect",function(){i.splice(i.indexOf(e.jwt.email),1),n.emit("connected users",i.filter(function(e,t,n){return n.indexOf(e)===t}))}),e.on("message",function(t){console.log(t),new s.default({channel:t.channel,text:t.text,userEmail:e.jwt.email}).save().then(function(t){n.emit("message",{_id:t._id,userEmail:t.userEmail,text:t.text,channel:t.channel,created:t.createdAt}),e.emit("message received")}).catch(function(t){console.error(t),e.emit("message receive error",t)})})}),n}},function(e,t){e.exports=require("socket.io")},function(e,t){e.exports=require("socketio-jwt")}]);
//# sourceMappingURL=server.js.map