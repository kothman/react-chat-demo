!function(e){var n={};function t(r){if(n[r])return n[r].exports;var s=n[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,t),s.l=!0,s.exports}t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var s in e)t.d(r,s,function(n){return e[n]}.bind(null,s));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=8)}([function(e,n){e.exports=require("mongoose")},function(e,n,t){e.exports={mongodbConnectionUri:process.env.MONGODB_URI,mongodbTestConnectionUri:"mongodb://localhost:27017/openChatTest",port:process.env.PORT||5e3,production:!0,useTestDb:process.env.USE_TEST_DB||!1,secret:process.env.SECRET||"secret",disableCsrf:process.env.DISABLE_CSRF||!1,disableReduxLogging:process.env.DISABLE_REDUX_LOGGING||!1,disableAutoStart:process.env.DISABLE_AUTO_START||!1,mailgunApiKey:process.env.MAILGUN_API_KEY,mailgunDomain:process.env.MAILGUN_DOMAIN,baseUrl:process.env.BASE_URL?process.env.BASE_URL:"http://localhost:5000"}},function(e,n){e.exports=require("bcryptjs")},function(e,n,t){"use strict";n.__esModule=!0;var r=t(0),s=new r.Schema({name:String,email:{required:!0,type:String,lowercase:!0},password:{type:String,required:!0},role:{type:String,required:!0,lowercase:!0,enum:["admin","user"]}},{timestamps:!0});s.statics.findByEmail=function(e){return this.findOne({email:e})};var o=r.model("User",s);n.default=o},function(e,n){e.exports=require("path")},function(e,n){e.exports=require("jsonwebtoken")},function(e,n){e.exports=require("validator")},function(e,n,t){"use strict";n.__esModule=!0;var r=t(0),s=new r.Schema({channel:{type:String,required:!0},text:{type:String,required:!0},userEmail:{type:String,required:!0,lowercase:!0}},{timestamps:!0}),o=r.model("Message",s);n.default=o},function(e,n,t){"use strict";(function(e){n.__esModule=!0;var r=t(9),s=t(10),o=t(4),i=t(0),u=t(11),a=t(12),c=t(13),l=t(14),d=t(2),f=t(15),m=t(16),p=t(5),g=t(17),h=t(18)(c),v=t(19),y=t(26),w=t(3),b=t(1),x=s();n.app=x;var j,_,S=b.port;n.socketServer=_,x.engine("html",g()),x.set("view engine","html"),x.use(m());var E=c({secret:b.secret,cookie:{maxAge:864e5,sameSite:!0,secure:b.production,httpOnly:!0},saveUninitialized:!0,resave:!1,store:new h({mongooseConnection:i.connection})}),k=u({cookie:{maxAge:864e5,sameSite:!0,secure:b.production,httpOnly:!0,key:"_csrf"}});i.connect(b.useTestDb?b.mongodbTestConnectionUri:b.mongodbConnectionUri,{useNewUrlParser:!0}),i.connection.on("error",function(e){console.error("Mongoose connection error",e)}),process.on("SIGINT",function(){i.connection.close(function(){console.log("Mongoose default connection disconnected through app termination"),process.exit(0)})}),x.use(E),x.use(a(b.secret)),b.disableCsrf?(console.log("CSRF disabled"),x.use(function(e,n,t){return e.csrfToken=function(){return""},t()})):x.use(k);var M=i.connection;x.use(function(e,n,t){return e.db=M,t()}),x.use(l.json()),x.use(l.urlencoded({extended:!0})),x.use(f()),x.use(s.static(o.resolve(e,"../../dist/public/"))),x.use("/api",function(e,n,t){return t()}),x.use(function(e,n,t){e.authenticate=function(e,n,t){w.default.findByEmail(e).then(function(e){if(null===e)return t(!1,null);if(!d.compareSync(n,e.password))return t(!1,new Error("Invalid password"));var r={email:e.email,name:e.name,role:e.role};return t(r,null)}).catch(function(e){t(!1,e)})},e.logout=function(){e.session.token=null},e.issueNewToken=function(t){var r=p.sign({name:t.name,role:t.role,email:t.email},b.secret,{expiresIn:86400});e.session.token=r,n.setHeader("x-access-token",r)},t()}),v.default(x),(j=r.createServer(x)).on("error",function(e){console.error(e),j.close()}),b.disableAutoStart||(n.socketServer=_=y.default(j,M),i.connection.on("connected",function(){console.log("Connected to MongoDB via Mongoose"),j.listen(S,function(){console.log("Listening on port "+S+"!"),x.emit("server started")})})),n.default=j,n.conn=i.connection}).call(this,"src/server")},function(e,n){e.exports=require("http")},function(e,n){e.exports=require("express")},function(e,n){e.exports=require("csurf")},function(e,n){e.exports=require("cookie-parser")},function(e,n){e.exports=require("express-session")},function(e,n){e.exports=require("body-parser")},function(e,n){e.exports=require("helmet")},function(e,n){e.exports=require("compression")},function(e,n){e.exports=require("mustache-express")},function(e,n){e.exports=require("connect-mongo")},function(e,n,t){"use strict";(function(e){n.__esModule=!0;var r=t(4),s=t(20),o=t(21),i=t(22),u=t(23),a=t(24);n.default=function(n){n.get("/",function(n,t){return t.render(r.resolve(e,"../../dist/public/index.html"),{csrfToken:n.csrfToken()})}),n.get("/widget",function(n,t){return t.render(r.resolve(e,"../../../dist/public/widget/index.html"))}),n.get("/widget/demo",function(n,t){return t.render(r.resolve(e,"../../../dist/public/widget/demo.html"))}),n.post("/api/v1/login",o.default.login),n.post("/api/v1/register",o.default.register),n.get("/api/v1/logout",o.default.logout),n.get("/api/v1/verifyEmail/:id",o.default.verifyEmail),n.use("/api/v1/user",s.default),n.get("/api/v1/user",i.default.user),n.get("/api/v1/users",i.default.users),n.get("/api/v1/user/:user",i.default.userByEmail),n.post("/api/v1/user/update/email",i.default.updateEmail),n.post("/api/v1/user/update/name",i.default.updateName),n.post("/api/v1/user/update/password",i.default.updatePassword),n.post("/api/v1/user/reset_password",i.default.resetPassword),n.get("/api/v1/message*",s.default),n.get("/api/v1/messages/:channel/:offset",u.default.messages),n.use("/api/v1/channel",s.default),n.get("/api/v1/channels",a.default.channels),n.post("/api/v1/channels/delete",a.default.delete),n.post("/api/v1/channels/create",a.default.create),n.get("*",function(n,t){return t.render(r.resolve(e,"../../dist/public/index.html"),{csrfToken:n.csrfToken()})})}}).call(this,"src/server")},function(e,n,t){"use strict";n.__esModule=!0;var r=t(5),s=t(1);n.default=function(e,n,t){e.session.token&&!e.headers["x-access-token"]&&n.setHeader("x-access-token",e.session.token);var o=e.headers["x-access-token"]||e.session.token;if(!o)return n.status(401).json({error:"Not authorized"});r.verify(o,s.secret,function(r,s){return r?n.status(401).send({error:"Not authorized"}):(e.user=s,t())})}},function(e,n,t){"use strict";n.__esModule=!0;var r=t(6),s=t(2),o=t(3);t(1);n.default={login:function(e,n){return r.isEmpty(e.body.email||"")||r.isEmpty(e.body.password||"")?n.status(400).json({error:"Please supply an email and password"}).end():r.isEmail(e.body.email)?void e.authenticate(e.body.email,e.body.password,function(t){return t?(e.issueNewToken(t),n.status(200).json({success:!0,email:t.email,role:t.role,name:t.name}).end()):n.status(401).json({error:"Invalid email or password"}).end()}):n.status(400).json({error:"Not a valid email address"}).end()},register:function(e,n){return r.isEmpty(e.body.email||"")||r.isEmpty(e.body.password||"")?n.status(400).json({error:"Please supply an email and password"}):r.isEmail(e.body.email)?o.default.findByEmail(e.body.email).countDocuments().exec().then(function(t){if(0!==t)return n.status(400).json({error:"Email address in use"});var r=s.hashSync(e.body.password);o.default.countDocuments().exec().then(function(t){var s="user";0===t&&(s="admin"),new o.default({name:"",email:e.body.email,password:r,role:s,emailVerified:!1}).save().then(function(e){return n.status(200).json({success:!0})}).catch(function(e){return console.error(e),n.status(500).json({error:"Something went wrong trying to create a new user"})})})}):n.status(400).json({error:"Not a valid email address"})},logout:function(e,n){return e.logout(),n.json({success:!0,message:"logged out"})},verifyEmail:function(e,n){}}},function(e,n,t){"use strict";n.__esModule=!0;var r=t(6),s=t(3),o=t(2);n.default={user:function(e,n){n.send(e.user)},users:function(e,n){return s.default.find({}).then(function(e){return n.status(200).json({success:!0,users:e})}).catch(function(e){return console.error(e),n.status(200).json({error:"Something went wrong while retrieving users"})})},userByEmail:function(e,n){return r.isEmail(e.params.user)?s.default.findByEmail(e.params.user).exec().then(function(e){return null!==e?n.status(200).json({user:{email:e.email,_id:e._id,name:e.name||""}}):n.status(400).json({error:"No user found with that email"})}).catch(function(e){return console.error(e),n.status(500).json({error:"Something went wrong trying to find the user"})}):n.status(400).json({error:"Please supply a valid email"})},updateEmail:function(e,n){return r.isEmail(e.body.email)?s.default.countDocuments({email:e.body.email}).exec().then(function(t){return 0!==t?n.status(400).json({error:"Email address already in use"}):s.default.findByEmail(e.user.email).exec().then(function(t){return t.email=e.body.email,t.save(),e.issueNewToken(Object.assign({},e.user,{email:e.body.email})),n.status(200).json({success:!0})}).catch(function(e){return console.error(e),n.status(500).json({error:"Something went wrong trying to fetch the user"})})}):n.status(400).json({error:"Not a valid email"})},updateName:function(e,n){return s.default.findByEmail(e.user.email).exec().then(function(t){return t.name=e.body.name,t.save(),e.issueNewToken(Object.assign({},e.user,{name:e.body.name})),n.status(200).json({success:!0})}).catch(function(e){return console.error(e),n.status(500).json({error:"Something went wrong trying to update the user"})})},updatePassword:function(e,n){return r.isEmpty(e.body.newPass)||r.isEmpty(e.body.oldPass)?n.status(400).json({error:"Must supply the current and new password"}):s.default.findByEmail(e.user.email).exec().then(function(t){return o.compareSync(e.body.oldPass,t.password)?(t.password=o.hashSync(e.body.newPass),t.save(),n.status(200).json({success:!0})):n.status(400).json({error:"Current password is incorrect"})})},resetPassword:function(e,n){return n.status(500).json({error:"Not implemented"})}}},function(e,n,t){"use strict";n.__esModule=!0;var r=t(7);n.default={messages:function(e,n){return r.default.find({channel:e.params.channel}).skip(parseInt(e.params.offest)).sort({_id:-1}).limit(20).exec().then(function(e){return n.status(200).json({messages:e.map(function(e){return{text:e.text,created:e.createdAt,userEmail:e.userEmail,channel:e.channel,_id:e._id}}).reverse()})}).catch(function(e){return n.status(400).json({error:"something went wrong trying to fetch messages"})})}}},function(e,n,t){"use strict";n.__esModule=!0;var r=t(25);n.default={channels:function(e,n){return r.default.countDocuments().exec().then(function(e){return new Promise(function(n,t){if(0!==e)return n();r.default.create([{name:"general"},{name:"random"}]).then(function(){return n()}).catch(function(e){return t(e)})}).then(function(){r.default.find().exec().then(function(e){return n.status(200).json({channels:e})}).catch(function(e){return console.log(e),n.status(500).json({error:"Something went wrong while trying to fetch channels"})})}).catch(function(e){return console.error(e),n.status(500).json({error:"Something went wrong while trying to create default channels"})})}).catch(function(e){return console.error(e),n.status(500).json({error:"Something went wrong while counting channels"})})},delete:function(e,n){},create:function(e,n){}}},function(e,n,t){"use strict";n.__esModule=!0;var r=t(0),s=new r.Schema({name:{type:String,required:!0,lowercase:!0}},{timestamps:!0}),o=r.model("Channel",s);n.default=o},function(e,n,t){"use strict";n.__esModule=!0;var r=t(27),s=t(28),o=t(7),i=t(1);n.default=function(e,n){var t=r(e),u=[];return t.on("connection",s.authorize({secret:i.secret,timeout:15e3,decodedPropertyName:"jwt"})).on("authenticated",function(e){u.push(e.jwt.email),console.log("Connected users",u),t.emit("connected users",u.filter(function(e,n,t){return t.indexOf(e)===n})),e.on("disconnect",function(){u.splice(u.indexOf(e.jwt.email),1),t.emit("connected users",u.filter(function(e,n,t){return t.indexOf(e)===n}))}),e.on("message",function(n){console.log(n),new o.default({channel:n.channel,text:n.text,userEmail:e.jwt.email}).save().then(function(n){t.emit("message",{_id:n._id,userEmail:n.userEmail,text:n.text,channel:n.channel,created:n.createdAt}),e.emit("message received")}).catch(function(n){console.error(n),e.emit("message receive error",n)})})}),t}},function(e,n){e.exports=require("socket.io")},function(e,n){e.exports=require("socketio-jwt")}]);
//# sourceMappingURL=server.js.map